<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Disiplin SK Cherating</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #eef2f7; font-family: 'Poppins', sans-serif; color: #333; }
        .app-card { max-width: 600px; margin: 30px auto; background: #ffffff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; border-top: 5px solid #0d6efd; }
        .app-header { padding: 30px 25px 10px 25px; background: white; text-align: center; }
        .main-logo { height: 80px; width: auto; display: block; margin: 0 auto 15px auto; object-fit: contain; }
        .app-title { font-weight: 700; font-size: 1.2rem; color: #1a1a1a; text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .app-body { padding: 25px; }
        
        /* STYLE INPUT MURID */
        .student-section { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef; margin-bottom: 15px; }
        .class-selector-row { display: flex; gap: 10px; margin-top: 10px; }
        .form-select { font-size: 0.9rem; border-radius: 5px; }
        .role-btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .role-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .role-btn.pelaku-mode.active { background: #dc3545; color: white; border-color: #dc3545; }
        .role-btn.mangsa-mode.active { background: #198754; color: white; border-color: #198754; }
        .btn-add { width: 100%; margin-top: 15px; background: #6c757d; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: 600; }
        .list-group-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .student-details { font-size: 0.8rem; color: #666; display: block; }
        .badge-pelaku { background: #ffe6e6; color: #dc3545; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; }
        .badge-mangsa { background: #e6f6ec; color: #198754; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; }
        .btn-remove { color: #aaa; cursor: pointer; border: none; background: none; }

        /* GAMBAR / VIDEO / AUDIO */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .preview-box { 
            position: relative; height: 120px; border: 1px solid #ddd; border-radius: 5px; 
            overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center;
        }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .preview-box video { width: 100%; height: 100%; object-fit: contain; }
        .preview-box audio { width: 90%; }
        
        .btn-del-img { position: absolute; top: 5px; right: 5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; border: none; cursor: pointer; z-index: 10; }

        .btn-submit { background: #0d6efd; color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; margin-top: 20px; }
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="app-header">
        <img src="logo_sekolah.jpg" alt="Logo" class="main-logo">
        <div class="app-title">PELAPORAN DISIPLIN<br>SK CHERATING</div>
    </div>

    <div class="app-body">
        <form id="formLaporan">
            
            <div class="mb-3">
                <label class="form-label">Nama Pelapor</label>
                <input type="text" id="nama" class="form-control" required placeholder="Nama Guru/Staf">
            </div>

            <div class="mb-3">
                <label class="form-label">Maklumat Murid</label>
                <div class="student-section">
                    <input type="text" id="inputMurid" class="form-control" placeholder="Masukkan Nama Murid">
                    
                    <div class="class-selector-row">
                        <select id="inputTahun" class="form-select">
                            <option value="">Pilih Tahun</option>
                            <option value="Pra Sekolah">Pra Sekolah</option>
                            <option value="Tahun 1">Tahun 1</option>
                            <option value="Tahun 2">Tahun 2</option>
                            <option value="Tahun 3">Tahun 3</option>
                            <option value="Tahun 4">Tahun 4</option>
                            <option value="Tahun 5">Tahun 5</option>
                            <option value="Tahun 6">Tahun 6</option>
                        </select>
                        <select id="inputKelas" class="form-select">
                            <option value="">Pilih Kelas</option>
                            <option value="Al-Farabi">Al-Farabi</option>
                            <option value="Al-Kindi">Al-Kindi</option>
                            <option value="Al-Biruni">Al-Biruni</option>
                            <option value="Al-Razi">Al-Razi</option>
                        </select>
                    </div>

                    <div class="role-btn-group">
                        <button type="button" class="role-btn pelaku-mode active" id="btnPelaku" onclick="setRole('Pelaku')">PELAKU</button>
                        <button type="button" class="role-btn mangsa-mode" id="btnMangsa" onclick="setRole('Mangsa')">MANGSA</button>
                    </div>

                    <button type="button" class="btn-add" onclick="tambahMurid()">+ Tambah Ke Senarai</button>
                </div>

                <ul class="list-group" id="senaraiPaparan"></ul>
                <div id="tiadaMuridMsg" style="font-size:0.8rem; color:#888; text-align:center; margin-top:5px;">Belum ada murid ditambah.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Tempat Kejadian</label>
                <input type="text" id="tempat" class="form-control" required placeholder="Contoh: Kantin">
            </div>

            <div class="mb-3">
                <label class="form-label">Ringkasan Laporan</label>
                <textarea id="ringkasan" class="form-control" rows="3" required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Bukti (Gambar/Video/Audio) - Max 2</label>
                <input type="file" id="files" class="form-control" accept="image/*,video/*,audio/*" multiple>
                <div class="preview-grid" id="previewGrid"></div>
            </div>

            <button type="submit" class="btn-submit">HANTAR LAPORAN</button>
        </form>
    </div>
</div>

<div class="loading" id="loading">
    <div class="spinner-border text-primary"></div>
    <div class="mt-2 fw-bold">Sedang Menghantar...</div>
    <div style="font-size: 0.8rem">Video mungkin mengambil masa lama...</div>
</div>

<script>
    // --- MASUKKAN URL WEB APP ANDA DI SINI ---
    const APP_URL = "https://script.google.com/macros/s/AKfycbw8j2EnihCLagap05bGpgQ4lbbpRPdsK0-3mS8msG4zSOgtwUHP3Ym-8xE1fD7K5Nek/exec"; 

    // --- LOGIC MURID ---
    let senaraiMurid = [];
    let currentRole = 'Pelaku';

    function setRole(role) {
        currentRole = role;
        if(role === 'Pelaku') {
            document.getElementById('btnPelaku').classList.add('active');
            document.getElementById('btnMangsa').classList.remove('active');
        } else {
            document.getElementById('btnPelaku').classList.remove('active');
            document.getElementById('btnMangsa').classList.add('active');
        }
    }

    function tambahMurid() {
        let nama = document.getElementById('inputMurid').value.trim();
        let tahun = document.getElementById('inputTahun').value;
        let kelas = document.getElementById('inputKelas').value;

        if(!nama) return alert("Sila masukkan nama murid.");
        if(!tahun) return alert("Sila pilih Tahun.");
        if(!kelas) return alert("Sila pilih Kelas.");

        senaraiMurid.push({ nama: nama, tahun: tahun, kelas: kelas, peranan: currentRole });
        document.getElementById('inputMurid').value = ""; 
        document.getElementById('inputTahun').value = ""; 
        document.getElementById('inputKelas').value = ""; 
        renderList();
    }

    function padamMurid(index) {
        senaraiMurid.splice(index, 1);
        renderList();
    }

    function renderList() {
        let listHtml = document.getElementById('senaraiPaparan');
        let msg = document.getElementById('tiadaMuridMsg');
        listHtml.innerHTML = "";

        if(senaraiMurid.length === 0) {
            msg.style.display = 'block';
        } else {
            msg.style.display = 'none';
            senaraiMurid.forEach((m, i) => {
                let badge = m.peranan === 'Pelaku' ? 'badge-pelaku' : 'badge-mangsa';
                let item = `
                    <li class="list-group-item">
                        <div>
                            <span class="${badge}">${m.peranan}</span> 
                            <span class="fw-bold ms-2">${m.nama}</span>
                            <span class="student-details">${m.tahun} ${m.kelas}</span>
                        </div>
                        <button type="button" class="btn-remove" onclick="padamMurid(${i})"><i class="fas fa-trash"></i></button>
                    </li>
                `;
                listHtml.innerHTML += item;
            });
        }
    }

    // --- LOGIC PREVIEW MEDIA (GAMBAR/VIDEO/AUDIO) ---
    let dt = new DataTransfer();
    document.getElementById('files').addEventListener('change', function(){
        dt = new DataTransfer(); 
        // Terima Image, Video, Audio
        for(let f of this.files) {
            if(f.type.startsWith('image/') || f.type.startsWith('video/') || f.type.startsWith('audio/')) {
                dt.items.add(f);
            }
        }
        if(dt.files.length > 2) { alert("Maksimum 2 fail sahaja."); return; }
        this.files = dt.files;
        renderMedia();
    });

    function renderMedia() {
        let grid = document.getElementById('previewGrid');
        grid.innerHTML = "";
        
        Array.from(dt.files).forEach((f, i) => {
            let reader = new FileReader();
            reader.onload = (e) => {
                let content = "";
                
                // Tentukan elemen berdasarkan jenis fail
                if(f.type.startsWith('image/')) {
                    content = `<img src="${e.target.result}">`;
                } else if (f.type.startsWith('video/')) {
                    content = `<video src="${e.target.result}" controls></video>`;
                } else if (f.type.startsWith('audio/')) {
                    content = `<audio src="${e.target.result}" controls></audio>`;
                }

                grid.innerHTML += `
                    <div class="preview-box">
                        ${content}
                        <button type="button" class="btn-del-img" onclick="delMedia(${i})">X</button>
                    </div>`;
            };
            reader.readAsDataURL(f);
        });
    }

    function delMedia(index) {
        let newDt = new DataTransfer();
        Array.from(dt.files).forEach((f, i) => { if(i !== index) newDt.items.add(f); });
        dt = newDt;
        document.getElementById('files').files = dt.files;
        renderMedia();
    }

    // --- HANTAR ---
    document.getElementById('formLaporan').addEventListener('submit', function(e){
        e.preventDefault();
        
        if(senaraiMurid.length === 0) return alert("Sila tambah sekurang-kurangnya seorang murid.");

        document.getElementById('loading').style.display = 'flex';

        let nama = document.getElementById('nama').value;
        let tempat = document.getElementById('tempat').value;
        let ringkasan = document.getElementById('ringkasan').value;
        
        let filePromises = Array.from(dt.files).map(file => {
            return new Promise((resolve, reject) => {
                let r = new FileReader();
                r.onload = () => resolve({ base64: r.result, type: file.type, name: file.name });
                r.onerror = reject;
                r.readAsDataURL(file);
            });
        });

        Promise.all(filePromises).then(filesData => {
            let payload = {
                nama: nama,
                senaraiMurid: senaraiMurid, 
                tempat: tempat,
                ringkasan: ringkasan,
                files: filesData
            };

            fetch(APP_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(json => {
                document.getElementById('loading').style.display = 'none';
                if(json.result === 'success') {
                    alert("Berjaya dihantar!");
                    location.reload();
                } else {
                    alert("Ralat Script: " + json.error);
                }
            })
            .catch(err => {
                document.getElementById('loading').style.display = 'none';
                alert("Gagal sambung ke server.");
            });
        });
    });
</script>

</body>
</html>
