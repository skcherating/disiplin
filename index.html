<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Disiplin SK Cherating</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #eef2f7; font-family: 'Poppins', sans-serif; color: #333; }
        .app-card { max-width: 600px; margin: 30px auto; background: #ffffff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; border-top: 5px solid #0d6efd; }
        .app-header { padding: 30px 25px 10px 25px; background: white; text-align: center; }
        .main-logo { height: 80px; width: auto; display: block; margin: 0 auto 15px auto; object-fit: contain; }
        .app-title { font-weight: 700; font-size: 1.2rem; color: #1a1a1a; text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .app-body { padding: 25px; }
        
        .student-section { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef; margin-bottom: 15px; }
        .class-selector-row { display: flex; gap: 10px; margin-top: 10px; }
        .form-select { font-size: 0.9rem; border-radius: 5px; }
        .role-btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .role-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .role-btn.pelaku-mode.active { background: #dc3545; color: white; border-color: #dc3545; }
        .role-btn.mangsa-mode.active { background: #198754; color: white; border-color: #198754; }
        .btn-add { width: 100%; margin-top: 15px; background: #6c757d; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: 600; }
        
        .list-group-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .student-details { font-size: 0.8rem; color: #666; display: block; }
        .badge-pelaku { background: #ffe6e6; color: #dc3545; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; }
        .badge-mangsa { background: #e6f6ec; color: #198754; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; }
        .btn-remove { color: #aaa; cursor: pointer; border: none; background: none; }

        /* STYLE FILE UPLOAD */
        .file-upload-wrapper {
            background: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .file-label { font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; display: block; }
        
        .preview-box { 
            position: relative; height: 100px; border: 1px solid #ddd; border-radius: 5px; 
            overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center;
            margin-top: 5px; display: none; 
        }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .preview-box video { width: 100%; height: 100%; object-fit: contain; }
        .preview-box audio { width: 90%; }
        
        .btn-clear-file {
            margin-top: 5px; font-size: 0.8rem; color: #dc3545; cursor: pointer; 
            background: none; border: none; padding: 0; display: none;
        }
        .btn-clear-file:hover { text-decoration: underline; }

        .btn-submit { background: #0d6efd; color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; margin-top: 20px; }
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="app-header">
        <img src="logo_sekolah.jpg" alt="Logo" class="main-logo">
        <div class="app-title">PELAPORAN DISIPLIN<br>SK CHERATING</div>
    </div>

    <div class="app-body">
        <form id="formLaporan">
            
            <div class="mb-3">
                <label class="form-label">Nama Pelapor</label>
                <input class="form-control" list="senaraiGuruOptions" id="nama" placeholder="Taip untuk cari nama..." required autocomplete="off">
                <datalist id="senaraiGuruOptions">
                    </datalist>
            </div>

            <div class="mb-3">
                <label class="form-label">Maklumat Murid</label>
                <div class="student-section">
                    <input type="text" id="inputMurid" class="form-control" placeholder="Masukkan Nama Murid">
                    
                    <div class="class-selector-row">
                        <select id="inputTahun" class="form-select">
                            <option value="">Pilih Tahun</option>
                            <option value="Pra Sekolah">Pra Sekolah</option>
                            <option value="Tahun 1">Tahun 1</option>
                            <option value="Tahun 2">Tahun 2</option>
                            <option value="Tahun 3">Tahun 3</option>
                            <option value="Tahun 4">Tahun 4</option>
                            <option value="Tahun 5">Tahun 5</option>
                            <option value="Tahun 6">Tahun 6</option>
                        </select>
                        <select id="inputKelas" class="form-select">
                            <option value="">Pilih Kelas</option>
                            <option value="Al-Farabi">Al-Farabi</option>
                            <option value="Al-Kindi">Al-Kindi</option>
                            <option value="Al-Biruni">Al-Biruni</option>
                            <option value="Al-Razi">Al-Razi</option>
                        </select>
                    </div>

                    <div class="role-btn-group">
                        <button type="button" class="role-btn pelaku-mode active" id="btnPelaku" onclick="setRole('Pelaku')">PELAKU</button>
                        <button type="button" class="role-btn mangsa-mode" id="btnMangsa" onclick="setRole('Mangsa')">MANGSA</button>
                    </div>

                    <button type="button" class="btn-add" onclick="tambahMurid()">+ Tambah Ke Senarai</button>
                </div>

                <ul class="list-group" id="senaraiPaparan"></ul>
                <div id="tiadaMuridMsg" style="font-size:0.8rem; color:#888; text-align:center; margin-top:5px;">Belum ada murid ditambah.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Tempat Kejadian</label>
                <input type="text" id="tempat" class="form-control" required placeholder="Contoh: Kantin">
            </div>

            <div class="mb-3">
                <label class="form-label">Ringkasan Laporan</label>
                <textarea id="ringkasan" class="form-control" rows="3" required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Muat Naik Bukti (Max 25MB/fail)</label>
                
                <div class="file-upload-wrapper">
                    <span class="file-label">Bukti 1 (Wajib)</span>
                    <input type="file" id="file1" class="form-control" accept="image/*,video/*,audio/*" onchange="handleFileSelect(this, 'preview1', 'clear1')">
                    <div id="preview1" class="preview-box"></div>
                    <button type="button" id="clear1" class="btn-clear-file" onclick="clearFile('file1', 'preview1', 'clear1')"><i class="fas fa-trash"></i> Padam Fail 1</button>
                </div>

                <div class="file-upload-wrapper">
                    <span class="file-label">Bukti 2 (Pilihan)</span>
                    <input type="file" id="file2" class="form-control" accept="image/*,video/*,audio/*" onchange="handleFileSelect(this, 'preview2', 'clear2')">
                    <div id="preview2" class="preview-box"></div>
                    <button type="button" id="clear2" class="btn-clear-file" onclick="clearFile('file2', 'preview2', 'clear2')"><i class="fas fa-trash"></i> Padam Fail 2</button>
                </div>
            </div>

            <button type="submit" class="btn-submit">HANTAR LAPORAN</button>
        </form>
    </div>
</div>

<div class="loading" id="loading">
    <div class="spinner-border text-primary"></div>
    <div class="mt-2 fw-bold">Sedang Menghantar...</div>
    <div style="font-size: 0.8rem">Sila tunggu, jangan tutup browser.</div>
</div>

<script>
    // --- MASUKKAN URL WEB APP ANDA DI SINI ---
    const APP_URL = "MASUKKAN_URL_WEB_APP_ANDA_DI_SINI"; 

    // --- SENARAI NAMA GURU & AKP (Dari Excel Anda) ---
    const senaraiGuru = [
        "ASRI BIN MOHAMED", "TUAN KAMARIAH BINTI TUAN SARIF", "ZAINON BINTI HJ JUFRI",
        "ASYRAF BIN ROSLAN", "AMIRAH BINTI CHE AZUHA", "AZLAN BIN DAUD",
        "AZLINA BINTI HANAPI", "AMANI BINTI AWANG QAMARULDEEN", "ANWAR SHAFIQ BIN JAMALUDIN",
        "ANIS SYAZWANI BINTI MAT ISA", "BAHJATU SHOLIHAH BINTI RAMAN", "FAZILAH BINTI MUDA",
        "HANIS AYUNI BINTI HADI", "KU MASITAH BINTI KU WIL", "MAKTAR BIN MOHAMED",
        "MOHD AFIZU BIN ADENAN", "MUHAMAD HAKIMI BIN AMER", "MUHAMMAD SAUFI FIRDAUS BIN SABUDIN",
        "NURAZIZAH BINTI OMAR", "NOOR IDAYU BINTI ISMAIL", "NOR HUDA DHAMIRAH BINTI ISA",
        "NUR IDAYU BINTI ABDULL ROZAK", "NOR NAZAHIYAH BINTI NASARUDIN", "NOR SHAZIRA BINTI AZIZ",
        "NOR SYAZALIAH BINTI MAT RADZI", "NURIN IZZAH BINTI ROSMAN", "NUR FATIHATULHUSNA BINTI YA'ACOB",
        "NURUL ADILAH BINTI ZAKARIA", "RAMLAH BINTI HASSAN", "RAZIAH BINTI WAHAB",
        "RAUDZAH BINTI HAJI KAMALUDIN", "RASHIDAH BINTI ZULKIFLI", "ROSHANIDA BINTI ROHANUDDIN",
        "SITI ZURAIHA BINTI MAPOL", "SUHAIDA BINTI SIDEK", "SUHAIMI BIN ISMAIL",
        "SUZIMARLIANA BINTI IBRAHIM"
        // NOTA: Anda boleh copy-paste nama lain di sini jika ada yang tertinggal
    ];

    // Masukkan senarai nama ke dalam Datalist HTML
    const datalist = document.getElementById('senaraiGuruOptions');
    senaraiGuru.sort(); // Susun ikut abjad
    senaraiGuru.forEach(nama => {
        const option = document.createElement('option');
        option.value = nama;
        datalist.appendChild(option);
    });

    // --- SETTING LAIN ---
    const MAX_SIZE_MB = 25; 
    const MAX_BYTES = MAX_SIZE_MB * 1024 * 1024;
    let senaraiMurid = [];
    let currentRole = 'Pelaku';

    function setRole(role) {
        currentRole = role;
        if(role === 'Pelaku') {
            document.getElementById('btnPelaku').classList.add('active');
            document.getElementById('btnMangsa').classList.remove('active');
        } else {
            document.getElementById('btnPelaku').classList.remove('active');
            document.getElementById('btnMangsa').classList.add('active');
        }
    }

    function tambahMurid() {
        let nama = document.getElementById('inputMurid').value.trim();
        let tahun = document.getElementById('inputTahun').value;
        let kelas = document.getElementById('inputKelas').value;

        if(!nama) return alert("Sila masukkan nama murid.");
        if(!tahun) return alert("Sila pilih Tahun.");
        if(!kelas) return alert("Sila pilih Kelas.");

        senaraiMurid.push({ nama: nama, tahun: tahun, kelas: kelas, peranan: currentRole });
        document.getElementById('inputMurid').value = ""; 
        document.getElementById('inputTahun').value = ""; 
        document.getElementById('inputKelas').value = ""; 
        renderList();
    }

    function padamMurid(index) {
        senaraiMurid.splice(index, 1);
        renderList();
    }

    function renderList() {
        let listHtml = document.getElementById('senaraiPaparan');
        let msg = document.getElementById('tiadaMuridMsg');
        listHtml.innerHTML = "";

        if(senaraiMurid.length === 0) {
            msg.style.display = 'block';
        } else {
            msg.style.display = 'none';
            senaraiMurid.forEach((m, i) => {
                let badge = m.peranan === 'Pelaku' ? 'badge-pelaku' : 'badge-mangsa';
                let item = `
                    <li class="list-group-item">
                        <div>
                            <span class="${badge}">${m.peranan}</span> 
                            <span class="fw-bold ms-2">${m.nama}</span>
                            <span class="student-details">${m.tahun} ${m.kelas}</span>
                        </div>
                        <button type="button" class="btn-remove" onclick="padamMurid(${i})"><i class="fas fa-trash"></i></button>
                    </li>
                `;
                listHtml.innerHTML += item;
            });
        }
    }

    // --- LOGIC FILE BERASINGAN ---
    function handleFileSelect(input, previewId, clearBtnId) {
        const file = input.files[0];
        const previewBox = document.getElementById(previewId);
        const clearBtn = document.getElementById(clearBtnId);

        if (!file) {
            previewBox.style.display = 'none';
            clearBtn.style.display = 'none';
            return;
        }

        if (file.size > MAX_BYTES) {
            alert(`Fail terlalu besar! Maksimum ${MAX_SIZE_MB}MB.`);
            input.value = ""; 
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            let content = "";
            if(file.type.startsWith('image/')) content = `<img src="${e.target.result}">`;
            else if (file.type.startsWith('video/')) content = `<video src="${e.target.result}" controls></video>`;
            else if (file.type.startsWith('audio/')) content = `<audio src="${e.target.result}" controls></audio>`;
            else content = `<div style="color:white; padding:10px;">${file.name}</div>`;

            previewBox.innerHTML = content;
            previewBox.style.display = 'flex';
            clearBtn.style.display = 'block';
        }
        reader.readAsDataURL(file);
    }

    function clearFile(inputId, previewId, clearBtnId) {
        document.getElementById(inputId).value = "";
        document.getElementById(previewId).innerHTML = "";
        document.getElementById(previewId).style.display = 'none';
        document.getElementById(clearBtnId).style.display = 'none';
    }

    // --- HANTAR ---
    document.getElementById('formLaporan').addEventListener('submit', function(e){
        e.preventDefault();
        
        if(APP_URL.includes("MASUKKAN_URL")) return alert("Sila masukkan URL Apps Script dahulu!");
        if(senaraiMurid.length === 0) return alert("Sila tambah sekurang-kurangnya seorang murid.");

        document.getElementById('loading').style.display = 'flex';

        let nama = document.getElementById('nama').value;
        let tempat = document.getElementById('tempat').value;
        let ringkasan = document.getElementById('ringkasan').value;
        
        let filesToProcess = [];
        const f1 = document.getElementById('file1').files[0];
        const f2 = document.getElementById('file2').files[0];

        if(f1) filesToProcess.push(f1);
        if(f2) filesToProcess.push(f2);

        let filePromises = filesToProcess.map(file => {
            return new Promise((resolve, reject) => {
                let r = new FileReader();
                r.onload = () => resolve({ base64: r.result, type: file.type, name: file.name });
                r.onerror = reject;
                r.readAsDataURL(file);
            });
        });

        Promise.all(filePromises).then(filesData => {
            let payload = {
                nama: nama,
                senaraiMurid: senaraiMurid, 
                tempat: tempat,
                ringkasan: ringkasan,
                files: filesData
            };

            fetch(APP_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(json => {
                document.getElementById('loading').style.display = 'none';
                if(json.result === 'success') {
                    alert("Berjaya dihantar!");
                    location.reload();
                } else {
                    alert("Ralat Script: " + json.error);
                }
            })
            .catch(err => {
                document.getElementById('loading').style.display = 'none';
                alert("Gagal sambung ke server.");
            });
        });
    });
</script>

</body>
</html>
